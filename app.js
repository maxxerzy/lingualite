let decks = [{ name: "DE-DA Starter (100)", cards: [{"front": "Deutsch Wort 1", "back": "Dänisch Ord 1", "example": "Satz med Ord 1"}, {"front": "Deutsch Wort 2", "back": "Dänisch Ord 2", "example": "Satz med Ord 2"}, {"front": "Deutsch Wort 3", "back": "Dänisch Ord 3", "example": "Satz med Ord 3"}, {"front": "Deutsch Wort 4", "back": "Dänisch Ord 4", "example": "Satz med Ord 4"}, {"front": "Deutsch Wort 5", "back": "Dänisch Ord 5", "example": "Satz med Ord 5"}, {"front": "Deutsch Wort 6", "back": "Dänisch Ord 6", "example": "Satz med Ord 6"}, {"front": "Deutsch Wort 7", "back": "Dänisch Ord 7", "example": "Satz med Ord 7"}, {"front": "Deutsch Wort 8", "back": "Dänisch Ord 8", "example": "Satz med Ord 8"}, {"front": "Deutsch Wort 9", "back": "Dänisch Ord 9", "example": "Satz med Ord 9"}, {"front": "Deutsch Wort 10", "back": "Dänisch Ord 10", "example": "Satz med Ord 10"}, {"front": "Deutsch Wort 11", "back": "Dänisch Ord 11", "example": "Satz med Ord 11"}, {"front": "Deutsch Wort 12", "back": "Dänisch Ord 12", "example": "Satz med Ord 12"}, {"front": "Deutsch Wort 13", "back": "Dänisch Ord 13", "example": "Satz med Ord 13"}, {"front": "Deutsch Wort 14", "back": "Dänisch Ord 14", "example": "Satz med Ord 14"}, {"front": "Deutsch Wort 15", "back": "Dänisch Ord 15", "example": "Satz med Ord 15"}, {"front": "Deutsch Wort 16", "back": "Dänisch Ord 16", "example": "Satz med Ord 16"}, {"front": "Deutsch Wort 17", "back": "Dänisch Ord 17", "example": "Satz med Ord 17"}, {"front": "Deutsch Wort 18", "back": "Dänisch Ord 18", "example": "Satz med Ord 18"}, {"front": "Deutsch Wort 19", "back": "Dänisch Ord 19", "example": "Satz med Ord 19"}, {"front": "Deutsch Wort 20", "back": "Dänisch Ord 20", "example": "Satz med Ord 20"}, {"front": "Deutsch Wort 21", "back": "Dänisch Ord 21", "example": "Satz med Ord 21"}, {"front": "Deutsch Wort 22", "back": "Dänisch Ord 22", "example": "Satz med Ord 22"}, {"front": "Deutsch Wort 23", "back": "Dänisch Ord 23", "example": "Satz med Ord 23"}, {"front": "Deutsch Wort 24", "back": "Dänisch Ord 24", "example": "Satz med Ord 24"}, {"front": "Deutsch Wort 25", "back": "Dänisch Ord 25", "example": "Satz med Ord 25"}, {"front": "Deutsch Wort 26", "back": "Dänisch Ord 26", "example": "Satz med Ord 26"}, {"front": "Deutsch Wort 27", "back": "Dänisch Ord 27", "example": "Satz med Ord 27"}, {"front": "Deutsch Wort 28", "back": "Dänisch Ord 28", "example": "Satz med Ord 28"}, {"front": "Deutsch Wort 29", "back": "Dänisch Ord 29", "example": "Satz med Ord 29"}, {"front": "Deutsch Wort 30", "back": "Dänisch Ord 30", "example": "Satz med Ord 30"}, {"front": "Deutsch Wort 31", "back": "Dänisch Ord 31", "example": "Satz med Ord 31"}, {"front": "Deutsch Wort 32", "back": "Dänisch Ord 32", "example": "Satz med Ord 32"}, {"front": "Deutsch Wort 33", "back": "Dänisch Ord 33", "example": "Satz med Ord 33"}, {"front": "Deutsch Wort 34", "back": "Dänisch Ord 34", "example": "Satz med Ord 34"}, {"front": "Deutsch Wort 35", "back": "Dänisch Ord 35", "example": "Satz med Ord 35"}, {"front": "Deutsch Wort 36", "back": "Dänisch Ord 36", "example": "Satz med Ord 36"}, {"front": "Deutsch Wort 37", "back": "Dänisch Ord 37", "example": "Satz med Ord 37"}, {"front": "Deutsch Wort 38", "back": "Dänisch Ord 38", "example": "Satz med Ord 38"}, {"front": "Deutsch Wort 39", "back": "Dänisch Ord 39", "example": "Satz med Ord 39"}, {"front": "Deutsch Wort 40", "back": "Dänisch Ord 40", "example": "Satz med Ord 40"}, {"front": "Deutsch Wort 41", "back": "Dänisch Ord 41", "example": "Satz med Ord 41"}, {"front": "Deutsch Wort 42", "back": "Dänisch Ord 42", "example": "Satz med Ord 42"}, {"front": "Deutsch Wort 43", "back": "Dänisch Ord 43", "example": "Satz med Ord 43"}, {"front": "Deutsch Wort 44", "back": "Dänisch Ord 44", "example": "Satz med Ord 44"}, {"front": "Deutsch Wort 45", "back": "Dänisch Ord 45", "example": "Satz med Ord 45"}, {"front": "Deutsch Wort 46", "back": "Dänisch Ord 46", "example": "Satz med Ord 46"}, {"front": "Deutsch Wort 47", "back": "Dänisch Ord 47", "example": "Satz med Ord 47"}, {"front": "Deutsch Wort 48", "back": "Dänisch Ord 48", "example": "Satz med Ord 48"}, {"front": "Deutsch Wort 49", "back": "Dänisch Ord 49", "example": "Satz med Ord 49"}, {"front": "Deutsch Wort 50", "back": "Dänisch Ord 50", "example": "Satz med Ord 50"}, {"front": "Deutsch Wort 51", "back": "Dänisch Ord 51", "example": "Satz med Ord 51"}, {"front": "Deutsch Wort 52", "back": "Dänisch Ord 52", "example": "Satz med Ord 52"}, {"front": "Deutsch Wort 53", "back": "Dänisch Ord 53", "example": "Satz med Ord 53"}, {"front": "Deutsch Wort 54", "back": "Dänisch Ord 54", "example": "Satz med Ord 54"}, {"front": "Deutsch Wort 55", "back": "Dänisch Ord 55", "example": "Satz med Ord 55"}, {"front": "Deutsch Wort 56", "back": "Dänisch Ord 56", "example": "Satz med Ord 56"}, {"front": "Deutsch Wort 57", "back": "Dänisch Ord 57", "example": "Satz med Ord 57"}, {"front": "Deutsch Wort 58", "back": "Dänisch Ord 58", "example": "Satz med Ord 58"}, {"front": "Deutsch Wort 59", "back": "Dänisch Ord 59", "example": "Satz med Ord 59"}, {"front": "Deutsch Wort 60", "back": "Dänisch Ord 60", "example": "Satz med Ord 60"}, {"front": "Deutsch Wort 61", "back": "Dänisch Ord 61", "example": "Satz med Ord 61"}, {"front": "Deutsch Wort 62", "back": "Dänisch Ord 62", "example": "Satz med Ord 62"}, {"front": "Deutsch Wort 63", "back": "Dänisch Ord 63", "example": "Satz med Ord 63"}, {"front": "Deutsch Wort 64", "back": "Dänisch Ord 64", "example": "Satz med Ord 64"}, {"front": "Deutsch Wort 65", "back": "Dänisch Ord 65", "example": "Satz med Ord 65"}, {"front": "Deutsch Wort 66", "back": "Dänisch Ord 66", "example": "Satz med Ord 66"}, {"front": "Deutsch Wort 67", "back": "Dänisch Ord 67", "example": "Satz med Ord 67"}, {"front": "Deutsch Wort 68", "back": "Dänisch Ord 68", "example": "Satz med Ord 68"}, {"front": "Deutsch Wort 69", "back": "Dänisch Ord 69", "example": "Satz med Ord 69"}, {"front": "Deutsch Wort 70", "back": "Dänisch Ord 70", "example": "Satz med Ord 70"}, {"front": "Deutsch Wort 71", "back": "Dänisch Ord 71", "example": "Satz med Ord 71"}, {"front": "Deutsch Wort 72", "back": "Dänisch Ord 72", "example": "Satz med Ord 72"}, {"front": "Deutsch Wort 73", "back": "Dänisch Ord 73", "example": "Satz med Ord 73"}, {"front": "Deutsch Wort 74", "back": "Dänisch Ord 74", "example": "Satz med Ord 74"}, {"front": "Deutsch Wort 75", "back": "Dänisch Ord 75", "example": "Satz med Ord 75"}, {"front": "Deutsch Wort 76", "back": "Dänisch Ord 76", "example": "Satz med Ord 76"}, {"front": "Deutsch Wort 77", "back": "Dänisch Ord 77", "example": "Satz med Ord 77"}, {"front": "Deutsch Wort 78", "back": "Dänisch Ord 78", "example": "Satz med Ord 78"}, {"front": "Deutsch Wort 79", "back": "Dänisch Ord 79", "example": "Satz med Ord 79"}, {"front": "Deutsch Wort 80", "back": "Dänisch Ord 80", "example": "Satz med Ord 80"}, {"front": "Deutsch Wort 81", "back": "Dänisch Ord 81", "example": "Satz med Ord 81"}, {"front": "Deutsch Wort 82", "back": "Dänisch Ord 82", "example": "Satz med Ord 82"}, {"front": "Deutsch Wort 83", "back": "Dänisch Ord 83", "example": "Satz med Ord 83"}, {"front": "Deutsch Wort 84", "back": "Dänisch Ord 84", "example": "Satz med Ord 84"}, {"front": "Deutsch Wort 85", "back": "Dänisch Ord 85", "example": "Satz med Ord 85"}, {"front": "Deutsch Wort 86", "back": "Dänisch Ord 86", "example": "Satz med Ord 86"}, {"front": "Deutsch Wort 87", "back": "Dänisch Ord 87", "example": "Satz med Ord 87"}, {"front": "Deutsch Wort 88", "back": "Dänisch Ord 88", "example": "Satz med Ord 88"}, {"front": "Deutsch Wort 89", "back": "Dänisch Ord 89", "example": "Satz med Ord 89"}, {"front": "Deutsch Wort 90", "back": "Dänisch Ord 90", "example": "Satz med Ord 90"}, {"front": "Deutsch Wort 91", "back": "Dänisch Ord 91", "example": "Satz med Ord 91"}, {"front": "Deutsch Wort 92", "back": "Dänisch Ord 92", "example": "Satz med Ord 92"}, {"front": "Deutsch Wort 93", "back": "Dänisch Ord 93", "example": "Satz med Ord 93"}, {"front": "Deutsch Wort 94", "back": "Dänisch Ord 94", "example": "Satz med Ord 94"}, {"front": "Deutsch Wort 95", "back": "Dänisch Ord 95", "example": "Satz med Ord 95"}, {"front": "Deutsch Wort 96", "back": "Dänisch Ord 96", "example": "Satz med Ord 96"}, {"front": "Deutsch Wort 97", "back": "Dänisch Ord 97", "example": "Satz med Ord 97"}, {"front": "Deutsch Wort 98", "back": "Dänisch Ord 98", "example": "Satz med Ord 98"}, {"front": "Deutsch Wort 99", "back": "Dänisch Ord 99", "example": "Satz med Ord 99"}, {"front": "Deutsch Wort 100", "back": "Dänisch Ord 100", "example": "Satz med Ord 100"}] }];

let currentDeck = null;
let currentMode = "flashcards";
let sessionQueue = [];
let currentCard = null;

function showSection(id) { document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function createDeck() { let name = prompt("Name des neuen Decks:"); if (name) { decks.push({name, cards: []}); renderDecks(); } }

function renderDecks() {
  let container = document.getElementById("deckList");
  container.innerHTML = "";
  decks.forEach((deck) => {
    let div = document.createElement("div");
    div.textContent = deck.name + " (" + deck.cards.length + " Karten)";
    div.className = "card";
    div.style.minHeight = "auto";
    div.onclick = () => { currentDeck = deck; alert(deck.name + " ausgewählt"); };
    container.appendChild(div);
  });
}

function startLearning() {
  if (!currentDeck) { currentDeck = decks[0]; }
  currentMode = document.getElementById("modeSelect").value;
  sessionQueue = [...currentDeck.cards];
  nextCard();
}

function nextCard() {
  if (sessionQueue.length === 0) { document.getElementById("learningArea").innerHTML = "<p>Session beendet!</p>"; return; }
  currentCard = sessionQueue.shift();
  if (currentMode === "flashcards") showFlashcard();
  else if (currentMode === "multiple") showMultipleChoice();
  else if (currentMode === "sentence") showSentencePuzzle();
}

function showFlashcard() {
  let area = document.getElementById("learningArea");
  area.innerHTML = `
    <div class="card">${currentCard.front}</div>
    <button class="reveal" onclick="revealAnswer()">Antwort zeigen</button>
    <button class="skip" onclick="skipCard()">Skip</button>
  `;
}

function revealAnswer() {
  let area = document.getElementById("learningArea");
  area.innerHTML += `
    <div class="feedback">Richtige Antwort: <b>${currentCard.back}</b></div>
    <button onclick="markCorrect()">Richtig</button>
    <button onclick="markWrong()">Falsch</button>
  `;
}

function markCorrect() {
  document.getElementById("learningArea").innerHTML += `<div class="feedback">✅ Richtig!</div>
    <button onclick="nextCard()">Weiter</button>`;
}

function markWrong() {
  sessionQueue.splice(1, 0, currentCard);
  document.getElementById("learningArea").innerHTML += `<div class="feedback">❌ Falsch! Lösung: <b>${currentCard.back}</b></div>
    <button onclick="nextCard()">Weiter</button>`;
}

function skipCard() {
  sessionQueue.push(currentCard);
  document.getElementById("learningArea").innerHTML += `<div class="feedback">⏭️ Übersprungen</div>
    <button onclick="nextCard()">Weiter</button>`;
}

function showMultipleChoice() {
  let options = [currentCard.back];
  while (options.length < 4 && currentDeck.cards.length > options.length) {
    let candidate = currentDeck.cards[Math.floor(Math.random() * currentDeck.cards.length)].back;
    if (!options.includes(candidate)) options.push(candidate);
  }
  options.sort(() => Math.random() - 0.5);
  let area = document.getElementById("learningArea");
  area.innerHTML = `<div class="card">${currentCard.front}</div>`;
  options.forEach(opt => {
    let btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => {
      if (opt === currentCard.back) {
        area.innerHTML += `<div class="feedback">✅ Richtig!</div><button onclick="nextCard()">Weiter</button>`;
      } else {
        sessionQueue.splice(1, 0, currentCard);
        area.innerHTML += `<div class="feedback">❌ Falsch! Lösung: <b>${currentCard.back}</b></div><button onclick="nextCard()">Weiter</button>`;
      }
    };
    area.appendChild(btn);
  });
  let skipBtn = document.createElement("button");
  skipBtn.textContent = "Skip";
  skipBtn.classList.add("skip");
  skipBtn.onclick = skipCard;
  area.appendChild(skipBtn);
}

function showSentencePuzzle() {
  let source = currentCard.example;
  let words = source.split(/\s+/);
  let shuffled = [...words].sort(() => Math.random() - 0.5);
  let area = document.getElementById("learningArea");
  area.innerHTML = `<div class="card">${currentCard.front}</div>`;
  let wordBank = document.createElement("div");
  let answerBox = document.createElement("div");
  shuffled.forEach(w => {
    let b = document.createElement("button");
    b.textContent = w;
    b.onclick = () => {
      answerBox.textContent += (answerBox.textContent ? " " : "") + w;
      b.disabled = true;
    };
    wordBank.appendChild(b);
  });
  area.appendChild(wordBank);
  area.appendChild(answerBox);
  let checkBtn = document.createElement("button");
  checkBtn.textContent = "Prüfen";
  checkBtn.onclick = () => {
    if (answerBox.textContent.trim() === source) {
      area.innerHTML += `<div class="feedback">✅ Richtig!</div><button onclick="nextCard()">Weiter</button>`;
    } else {
      sessionQueue.splice(1, 0, currentCard);
      area.innerHTML += `<div class="feedback">❌ Falsch! Lösung: <b>${source}</b></div><button onclick="nextCard()">Weiter</button>`;
    }
  };
  area.appendChild(checkBtn);
  let skipBtn = document.createElement("button");
  skipBtn.textContent = "Skip";
  skipBtn.classList.add("skip");
  skipBtn.onclick = skipCard;
  area.appendChild(skipBtn);
}

function handleFileImport(e) {
  let file = e.target.files[0];
  let reader = new FileReader();
  reader.onload = function(evt) {
    try {
      let imported = JSON.parse(evt.target.result);
      decks = decks.concat(imported);
      renderDecks();
      alert("Import erfolgreich!");
    } catch (err) { alert("Fehler beim Import"); }
  };
  reader.readAsText(file);
}

function importFromText() {
  let text = document.getElementById("importText").value.trim();
  if (!decks[0]) { decks.push({name:"Eigenes Deck", cards:[]}); }
  if (!currentDeck) { currentDeck = decks[0]; }
  let lines = text.split("\n");
  lines.forEach(line => {
    let parts = line.split(";");
    if (parts.length >= 2) {
      currentDeck.cards.push({front: parts[0], back: parts[1], example: parts[2] || ""});
    }
  });
  renderDecks();
}

function exportDecks() {
  let blob = new Blob([JSON.stringify(decks)], {type: "application/json"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "decks.json";
  a.click();
}

renderDecks();
